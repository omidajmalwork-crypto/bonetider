<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0e27">
    <title>MUSLIMSK B√∂netider</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-gold: #FFD700;
            --secondary-gold: #FFA500;
            --dark-bg: #0a0e27;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 215, 0, 0.2);
            --success-green: #00ff88;
            --islamic-green: #0f766e;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f4d 50%, #0f1538 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary-gold), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .hero-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 768px) {
            .hero-section { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
            .extra-grid { grid-template-columns: 1fr !important; }
        }
        .extra-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .clock-card, .tip-card, .ramadan-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 30px 20px;
            backdrop-filter: blur(20px);
            text-align: center;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            position: relative;
            overflow: hidden;
        }
        .tip-card {
            text-align: left;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.2), rgba(255, 215, 0, 0.05));
            border-color: rgba(15, 118, 110, 0.5);
        }
        .ramadan-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 255, 136, 0.05));
        }
        .time-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #fff, var(--primary-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 15px 0;
        }
        .prayer-section, .alarm-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 25px;
            backdrop-filter: blur(20px);
            margin-bottom: 30px;
        }
        .section-title {
            color: var(--primary-gold);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .prayer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .prayer-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,215,0,0.1);
            border-radius: 15px;
            padding: 15px 5px;
            text-align: center;
            transition: all 0.3s;
        }
        .prayer-card.active {
            border-color: var(--primary-gold);
            background: rgba(255,215,0,0.1);
            transform: scale(1.05);
        }
        .alarm-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .alarm-input, .adhan-selector {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }
        .alarm-input { flex: 1; min-width: 120px; }
        .adhan-selector { flex: 2; min-width: 200px; cursor: pointer; }
        .adhan-selector option { background: #0a0e27; color: white; }
        .btn {
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            border: none;
            color: #0a0e27;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            transition: transform 0.2s, box-shadow 0.3s;
            touch-action: manipulation;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,215,0,0.3); }
        .btn:active { transform: scale(0.95); }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid var(--glass-border);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-next {
            background: rgba(15, 118, 110, 0.3);
            color: #5eead4;
            border: 1px solid rgba(94, 234, 212, 0.3);
            padding: 8px 20px;
            font-size: 0.9rem;
            margin-top: 15px;
        }
        .btn-next:hover { background: rgba(15, 118, 110, 0.5); }
        .days-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .day-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05);
            color: #888;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .day-btn.active {
            background: var(--primary-gold);
            color: #0a0e27;
            border-color: var(--primary-gold);
        }
        .alarm-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .alarm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .alarm-modal.active { display: flex; }
        .alarm-modal-content {
            background: linear-gradient(135deg, #1a1f4d, #0a0e27);
            border: 2px solid var(--primary-gold);
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            border-radius: 15px;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
        }
        .notification.show { transform: translateX(0); }
        .audio-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .audio-overlay.hidden { display: none; }
        .start-btn {
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            color: #0a0e27;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            animation: pulse 2s infinite;
            margin-top: 20px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            color: #888;
        }
        input[type="range"] { flex: 1; accent-color: var(--primary-gold); }
        
        /* Nya stilar f√∂r Tips/R√•d */
        .tip-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #e2e8f0;
            margin: 15px 0;
            font-style: italic;
            min-height: 80px;
            display: flex;
            align-items: center;
        }
        .tip-category {
            display: inline-block;
            background: rgba(94, 234, 212, 0.2);
            color: #5eead4;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .tip-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        /* Nya stilar f√∂r Ramadan Tracker */
        .fasting-status {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .fast-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        .fast-checkbox:hover {
            border-color: var(--primary-gold);
            background: rgba(255,215,0,0.05);
        }
        .fast-checkbox.checked {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--success-green);
        }
        .fast-checkbox input {
            width: 24px;
            height: 24px;
            accent-color: var(--success-green);
            cursor: pointer;
        }
        .streak-counter {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--primary-gold);
            margin: 10px 0;
        }
        .streak-label {
            font-size: 0.9rem;
            color: #888;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
            font-size: 0.75rem;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            color: #666;
        }
        
        .calendar-day.today {
            border: 2px solid var(--primary-gold);
        }
		
		.calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer}
        .calendar-day.fast{background:rgba(0,255,136,.4)}
        .calendar-day.missed{background:rgba(255,0,0,.4)}
        .calendar-day.today{border:2px solid var(--primary-gold)}
        .stats{display:flex;justify-content:space-around;margin:10px 0}

    </style>
</head>
<body>
    <div id="startOverlay" class="audio-overlay">
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üïå</div>
            <h2 style="font-family: Orbitron; color: var(--primary-gold); margin-bottom: 10px;">V√§lkommen</h2>
            <p style="color: #ccc; margin-bottom: 30px; line-height: 1.6;">
                Tryck p√• knappen nedan f√∂r att aktivera b√∂neutrop (Adhan)<br>
                <small style="color: #888;">Kr√§vs endast en g√•ng per bes√∂k</small>
            </p>
            <button class="start-btn" onclick="startApp()">üîî Aktivera Alarm & Ljud</button>
        </div>
    </div>

    <div class="stars" id="stars"></div>
    <div class="container">
        <div class="header">
            <h1>MUSLIMSK KALENDER</h1>
            <div style="color: #888; margin-bottom: 20px;">B√∂netider, Dua & Ramadan-tracker</div>
            <div style="background: rgba(255,215,0,0.1); border: 1px solid var(--glass-border); padding: 10px 20px; border-radius: 50px; display: inline-block; color: var(--primary-gold); font-size: 0.9rem;">
                <span id="audioStatus">‚ö†Ô∏è V√§ntar p√• aktivering...</span>
            </div>
        </div>

		<div style="text-align:center; margin-bottom:10px;">
  <span id="cityDisplay" style="font-size:0.9rem; opacity:0.8;"></span>
  <br>
  <button class="btn btn-secondary" onclick="changeCity()">Byt stad</button>
</div>


        <div class="hero-section">
            <div class="clock-card">
                <div style="color: #888; font-size: 0.9rem;">Nuvarande tid</div>
                <div class="time-display" id="timeDisplay">00:00:00</div>
                <div id="dateDisplay" style="color: #ccc;">Laddar...</div>
                <div id="islamicDate" style="color: var(--primary-gold); margin-top: 5px;">Laddar...</div>
            </div>
            <div class="clock-card">
                <div style="color: #888; font-size: 0.9rem;">N√§sta b√∂n</div>
                <div class="time-display" id="nextPrayerTime" style="font-size: 2rem;">--:--</div>
                <div id="nextPrayerName" style="color: var(--primary-gold); font-size: 1.2rem;">Laddar...</div>
            </div>
        </div>



        <div class="prayer-section">
            <div class="section-title">üìø Dagens b√∂netider</div>
            <div class="prayer-grid" id="prayerGrid"><div class="prayer-card">Laddar...</div></div>
        </div>
		
		        <!-- Nya sektioner: Tips/Dua och Ramadan Tracker -->
        <div class="extra-grid">
            <!-- Tips & Dua Box -->
            <div class="tip-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span class="tip-category" id="tipCategory">DUA</span>
                    <span style="font-size: 1.5rem;">üìø</span>
                </div>
                <div class="tip-content" id="tipContent">
                    Laddar...
                </div>
				
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                   <button class="btn btn-next" onclick="prevTip()">‚Üê F√∂rra</button>
                   <span style="font-size:0.8rem; color:#666;" id="tipCounter">1 / 20</span>
                    <button class="btn btn-next" onclick="nextTip()">N√§sta ‚Üí</button>
                  </div>

            </div>

            <!-- Ramadan Tracker Box -->
            <div class="ramadan-card">
    <div class="section-title" style="justify-content: center; margin-bottom: 10px;">
        üåô Ramadan Tracker
    </div>

    <div class="calendar-nav">
        <button class="btn btn-secondary" onclick="changeMonth(-1)">‚¨Ö</button>
        <div id="monthLabel"></div>
        <button class="btn btn-secondary" onclick="changeMonth(1)">‚û°</button>
    </div>

    <div class="stats">
        <div>üü¢ Fastat: <span id="fastCount">0</span></div>
        <div>üî¥ Missat: <span id="missedCount">0</span></div>
    </div>

    <div class="calendar-grid" id="calendar"></div>
</div>
        </div>

        <div class="alarm-section">
            <div class="section-title">‚è∞ Alarm med Adhan</div>
            <div class="alarm-controls">
                <input type="time" id="alarmTime" class="alarm-input">
                <input type="text" id="alarmLabel" class="alarm-input" placeholder="Namn (t.ex. Fajr)" style="flex: 2;">
            </div>
            <div class="alarm-controls">
                <select id="adhanType" class="adhan-selector">
                    <option value="makkah">üïã Makkah - Masjid al-Haram</option>
                    <option value="madinah">üïå Madinah - Masjid an-Nabawi</option>
                    <option value="alaqsa">ü§≤ Al-Aqsa - Jerusalem</option>
                    <option value="turkish">üáπüá∑ Turkisk stil</option>
                    <option value="egyptian">üá™üá¨ Egyptisk stil</option>
                    <option value="beep">üîî Enkel signal</option>
                </select>
            </div>
            <div class="volume-control">
                <span>Volym:</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="80">
                <span id="volumeValue">80%</span>
                <button class="btn btn-secondary" onclick="testSound()" style="margin-left: 10px;">Testa ljud</button>
            </div>
            <div class="days-selector" id="daysSelector">
                <button class="day-btn active" onclick="toggleDay(1)">M√•n</button>
                <button class="day-btn active" onclick="toggleDay(2)">Tis</button>
                <button class="day-btn active" onclick="toggleDay(3)">Ons</button>
                <button class="day-btn active" onclick="toggleDay(4)">Tor</button>
                <button class="day-btn active" onclick="toggleDay(5)">Fre</button>
                <button class="day-btn active" onclick="toggleDay(6)">L√∂r</button>
                <button class="day-btn active" onclick="toggleDay(0)">S√∂n</button>
            </div>
            <button class="btn" onclick="addAlarm()" style="width: 100%; margin-bottom: 20px;">Spara Alarm</button>
            <div id="alarmList"></div>
        </div>
    </div>

    <div class="alarm-modal" id="alarmModal">
        <div class="alarm-modal-content">
            <div style="font-size: 5rem; margin-bottom: 20px;">üïå</div>
            <div id="modalTime" style="font-family: Orbitron; font-size: 3rem; color: var(--primary-gold); margin-bottom: 10px;">00:00</div>
            <div id="modalLabel" style="font-size: 1.5rem; margin-bottom: 30px;">B√∂nedags!</div>
            <button class="btn" onclick="stopAlarm()" style="padding: 15px 40px; font-size: 1.1rem; background: #ff6b6b; color: white;">St√§ng av</button>
        </div>
    </div>

    <div class="notification" id="notification">
        <div style="font-weight: bold; margin-bottom: 5px;" id="notifTitle"></div>
        <div id="notifText"></div>
    </div>

<script>
// Globala variabler
let audioContext = null;
let currentAudio = null;
let isAudioReady = false;
let alarmVolume = 0.8;
let alarms = JSON.parse(localStorage.getItem('myPrayerAlarms')) || [];
let selectedDays = [0,1,2,3,4,5,6];
let prayers = {};
const adhanAudios = {};

// Adhan-ljud
const adhanFiles = {
    makkah: 'https://www.islamcan.com/audio/adhan/azan1.mp3',
    madinah: 'https://www.islamcan.com/audio/adhan/azan2.mp3',
    alaqsa: 'https://www.islamcan.com/audio/adhan/azan3.mp3',
    turkish: 'https://www.islamcan.com/audio/adhan/azan4.mp3',
    egyptian: 'https://www.islamcan.com/audio/adhan/azan5.mp3'
};

// ===== TIPS/DUA DATABAS =====
const tipsData = [
    { category: 'DUA', text: 'Allahumma innaka afuwwun, tuhibbul afwa, fa afu anni (O Allah, Du √§r den som f√∂rl√•ter, Du √§lskar att f√∂rl√•ta, s√• f√∂rl√•t mig)' },
    { category: 'R√ÖD', text: 'Sm√• goda handlingar g√∂ra varje dag. Ett leende till en broder eller syster √§r sadaqa (v√§lg√∂renhet).' },
    { category: 'TIPS', text: 'Drick mycket vatten mellan iftar och suhur under Ramadan f√∂r att undvika uttorkning.' },
    { category: 'DUA', text: 'Rabbana atina fid-dunya hasanatan wa fil akhirati hasanatan wa qina adhaban-nar (V√•r Herre, ge oss gott i denna v√§rld och gott i n√§sta, och skydda oss fr√•n helvetets straff)' },
    { category: 'R√ÖD', text: 'L√§s Quran √§ven om det bara √§r en vers om dagen. Konsistens √§r viktigare √§n kvantitet.' },
    { category: 'TIPS', text: 'Be nattb√∂n (Tahajjud) √§ven om det bara √§r tv√• raka\'at f√∂re Fajr.' },
    { category: 'DUA', text: 'SubhanAllahi wa bihamdihi, subhanAllahil adheem (Glorifierad √§r Allah och prisad √§r Han, glorifierad √§r Allah den Majest√§tiske) - s√§gs vid sv√•righeter' },
    { category: 'R√ÖD', text: 'T√§nk p√• d√∂den ofta. Det p√•minner oss om att prioritera det eviga livet.' },
    { category: 'TIPS', text: 'Ge sadaqa varje fredag, √§ven om det bara √§r en slant. Det avl√§gsnar sv√•righeter.' },
    { category: 'DUA', text: 'La hawla wa la quwwata illa billah (Det finns ingen makt och styrka utom genom Allah) - s√§gs vid svaghet' },
    { category: 'R√ÖD', text: 'H√•ll tungan. Kontrollera vad du s√§ger, f√∂r den kan s√§nda dig till helvetet eller paradiset.' },
    { category: 'TIPS', text: 'G√∂r wudu direkt n√§r du vaknar. Det ger baraka (v√§lsignelse) i dagen.' },
    { category: 'DUA', text: 'Rabbana hab lana min azwajina wa dhuriyyatina qurrata a\'yunin wajalna lil muttaqina imama (V√•r Herre, sk√§nk oss fr√•n v√•ra familj en tr√∂st f√∂r √∂gonen)' },
    { category: 'R√ÖD', text: 'S√§g Bismillah innan allt du g√∂r, s√• f√•r du v√§lsignelse i det.' },
    { category: 'TIPS', text: '√Ñt duggri (med h√∂ger hand) och fr√•n det som √§r n√§rmast dig, enligt Sunnah.' },
    { category: 'DUA', text: 'Astaghfirullah (Jag ber Allah om f√∂rl√•telse) - s√§g 100 g√•nger dagligen f√∂r rening.' },
    { category: 'R√ÖD', text: 'Bes√∂k sjuka och f√∂lj begravningar. Det p√•minner oss om livets korthet.' },
    { category: 'TIPS', text: 'Bryt fasta med dadlar eller vatten, enligt Sunnah.' },
    { category: 'DUA', text: 'Allahumma inni asaluka al-jannah wa a\'udhu bika min an-nar (O Allah, jag ber Dig om Paradiset och s√∂ker skydd hos Dig fr√•n Elden)' },
    { category: 'R√ÖD', text: 'T√•lamod (Sabr) √§r halva tron. √ñva t√•lamod i sv√•righeter.' }
];

let currentTipIndex = 0;

// ===== START APP =====
async function startApp() {
    try {
        document.getElementById('startOverlay').classList.add('hidden');
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
        }
        
        const buffer = audioContext.createBuffer(1, 1, 22050);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start();

        Object.entries(adhanFiles).forEach(([key, url]) => {
            const audio = new Audio(url);
            audio.volume = alarmVolume;
            audio.playsInline = true;
            adhanAudios[key] = audio;
        });

        isAudioReady = true;
        document.getElementById('audioStatus').innerHTML = '‚úÖ Alarm aktivt - Adhan kommer spelas';
        document.getElementById('audioStatus').style.color = '#00ff88';
        
        showNotification('Klar!', 'B√∂neutrop √§r nu aktiverade.');
        requestWakeLock();
        
        // Initiera tips och ramadan
        initTips();
        //initRamadanTracker();
    } catch (e) {
        console.error('Audio init failed:', e);
        alert('Kunde inte aktivera ljud.');
    }
}

// ===== TIPS/DUA FUNKTIONER =====
function initTips() {
    // Slumpa startindex
        const saved = localStorage.getItem('lastTipIndex');
        if(saved !== null){
         currentTipIndex = parseInt(saved);
}else{
  currentTipIndex = Math.floor(Math.random() * tipsData.length);
}
displayTip();
}

function displayTip() {
    const tip = tipsData[currentTipIndex];
    document.getElementById('tipCategory').textContent = tip.category;
    document.getElementById('tipContent').textContent = tip.text;
    document.getElementById('tipCounter').textContent = `${currentTipIndex + 1} / ${tipsData.length}`;
    
    // Spara senaste visade index
    localStorage.setItem('lastTipIndex', currentTipIndex);
}

function nextTip() {
    currentTipIndex = (currentTipIndex + 1) % tipsData.length;
    displayTip();
}
	
function prevTip() {
    currentTipIndex = (currentTipIndex - 1 + tipsData.length) % tipsData.length;
    displayTip();
}

// ===== RAMADAN TRACKER FUNKTIONER =====
let currentMonth=new Date().getMonth();
let currentYear=new Date().getFullYear();

function getRamadanData(){
 return JSON.parse(localStorage.getItem("ramadanDays")||"{}");
}
function saveRamadanData(d){
 localStorage.setItem("ramadanDays",JSON.stringify(d));
}

function changeMonth(dir){
 currentMonth+=dir;
 if(currentMonth<0){currentMonth=11;currentYear--;}
 if(currentMonth>11){currentMonth=0;currentYear++;}
 renderRamadanCalendar();
}

function renderRamadanCalendar(){
 const cal=document.getElementById("calendar");
 cal.innerHTML="";
 const label=document.getElementById("monthLabel");
 label.innerText=new Date(currentYear,currentMonth).toLocaleDateString("sv-SE",{month:"long",year:"numeric"});
 const days=new Date(currentYear,currentMonth+1,0).getDate();
 const data=getRamadanData();

 let fast=0, missed=0;
 Object.values(data).forEach(v=>{
   if(v==1) fast++;
   if(v==2) missed++;
 });

 for(let d=1;d<=days;d++){
   const date=`${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
   const div=document.createElement("div");
   div.className="calendar-day";
   div.innerText=d;

   if(data[date]==1) div.classList.add("fast");
   if(data[date]==2) div.classList.add("missed");

   const today=new Date().toISOString().split("T")[0];
   if(date===today) div.classList.add("today");

   div.onclick=()=>{
     let v=data[date]||0;
     v=(v+1)%3;
     if(v===0) delete data[date]; else data[date]=v;
     saveRamadanData(data);
     renderRamadanCalendar();
   }

   cal.appendChild(div);
 }

 document.getElementById("fastCount").innerText=fast;
 document.getElementById("missedCount").innerText=missed;
}


renderRamadanCalendar();


// ===== LJUD-FUNKTIONER =====
function playAdhan(type) {
    if (!isAudioReady) {
        document.getElementById('startOverlay').classList.remove('hidden');
        return;
    }

    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }

    if (type === 'beep') {
        playBeepLoop();
        return;
    }

    currentAudio = adhanAudios[type] || adhanAudios['makkah'];
    currentAudio.currentTime = 0;
    currentAudio.play().catch(err => {
        console.log('Play blocked:', err);
        playBeepLoop();
    });
}

function playBeepLoop() {
    if (!audioContext) return;
    const playBeep = () => {
        if (!isAudioReady) return;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(alarmVolume * 0.3, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        osc.start();
        osc.stop(audioContext.currentTime + 0.3);
    };
    playBeep();
    window.beepInterval = setInterval(playBeep, 1000);
}

function stopAlarm() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    if (window.beepInterval) clearInterval(window.beepInterval);
    document.getElementById('alarmModal').classList.remove('active');
    if (navigator.vibrate) navigator.vibrate(0);
}

function testSound() {
    if (!isAudioReady) {
        alert('Tryck p√• "Aktivera Alarm & Ljud" f√∂rst!');
        return;
    }
    const type = document.getElementById('adhanType').value;
    showNotification('Testar', 'Spelar upp ' + type + '...');
    playAdhan(type);
}

// ===== ALARM-HANTERING =====
function addAlarm() {
    if (!isAudioReady) {
        document.getElementById('startOverlay').classList.remove('hidden');
        return;
    }

    const time = document.getElementById('alarmTime').value;
    const label = document.getElementById('alarmLabel').value || 'B√∂n';
    const type = document.getElementById('adhanType').value;

    if (!time) {
        showNotification('Fel', 'V√§lj en tid f√∂rst');
        return;
    }

    const alarm = {
        id: Date.now(),
        time: time,
        label: label,
        type: type,
        days: [...selectedDays],
        active: true
    };

    alarms.push(alarm);
    alarms.sort((a,b) => a.time.localeCompare(b.time));
    localStorage.setItem('myPrayerAlarms', JSON.stringify(alarms));
    
    renderAlarms();
    document.getElementById('alarmTime').value = '';
    document.getElementById('alarmLabel').value = '';
    showNotification('Sparat!', `${label} kl ${time}`);
}

function deleteAlarm(id) {
    alarms = alarms.filter(a => a.id !== id);
    localStorage.setItem('myPrayerAlarms', JSON.stringify(alarms));
    renderAlarms();
}

function renderAlarms() {
    const container = document.getElementById('alarmList');
    if (alarms.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Inga alarm inst√§llda</div>';
        return;
    }
    const dayNames = ['S√∂n','M√•n','Tis','Ons','Tor','Fre','L√∂r'];
    container.innerHTML = alarms.map(alarm => `
        <div class="alarm-item">
            <div>
                <div style="font-family: Orbitron; font-size: 1.3rem; color: white;">${alarm.time}</div>
                <div style="color: #888; font-size: 0.9rem;">
                    ${alarm.label} | ${alarm.type} | ${alarm.days.map(d => dayNames[d]).join(', ')}
                </div>
            </div>
            <button onclick="deleteAlarm(${alarm.id})" style="background: rgba(255,0,0,0.3); color: #ff6b6b; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;">Ta bort</button>
        </div>
    `).join('');
}

function toggleDay(day) {
    const idx = selectedDays.indexOf(day);
    if (idx > -1) {
        if (selectedDays.length > 1) selectedDays.splice(idx, 1);
    } else {
        selectedDays.push(day);
        selectedDays.sort();
    }
    updateDayButtons();
}

function updateDayButtons() {
    const buttons = document.querySelectorAll('.day-btn');
    const dayOrder = [1,2,3,4,5,6,0];
    buttons.forEach((btn, idx) => {
        btn.classList.toggle('active', selectedDays.includes(dayOrder[idx]));
    });
}

// ===== CLOCK & API =====
function updateClock() {
    const now = new Date();
    document.getElementById('timeDisplay').innerText = now.toTimeString().substring(0,8);
    checkAlarms(now);
}

async function loadPrayerTimes() {
    try {
        let latitude;
        let longitude;
        let cityName = localStorage.getItem("cityName");

        // Om vi redan sparat stad ‚Üí anv√§nd den
        if (localStorage.getItem("lat") && localStorage.getItem("lon")) {
            latitude = localStorage.getItem("lat");
            longitude = localStorage.getItem("lon");
        } else if (navigator.geolocation) {
            // F√∂rs√∂k GPS
            await new Promise(resolve => {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        latitude = pos.coords.latitude;
                        longitude = pos.coords.longitude;
                        localStorage.setItem("lat", latitude);
                        localStorage.setItem("lon", longitude);
                        resolve();
                    },
                    () => resolve()
                );
            });
        }

        // Om fortfarande ingen position ‚Üí fr√•ga stad
        if (!latitude || !longitude) {
            await askCity();
            return;
        }

        const response = await fetch(
            `https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=3`
        );

        const data = await response.json();
        const t = data.data.timings;

        prayers = {
            fajr: t.Fajr.substring(0,5),
            sunrise: t.Sunrise.substring(0,5),
            dhuhr: t.Dhuhr.substring(0,5),
            asr: t.Asr.substring(0,5),
            maghrib: t.Maghrib.substring(0,5),
            isha: t.Isha.substring(0,5)
        };

        renderPrayers();
        updateNextPrayer();

        document.getElementById('dateDisplay').innerText =
          new Date().toLocaleDateString('sv-SE', {weekday:'long', day:'numeric', month:'long', year:'numeric'});

        document.getElementById('islamicDate').innerText =
          `${data.data.date.hijri.day} ${data.data.date.hijri.month.en} ${data.data.date.hijri.year} AH`;

        if (cityName) {
            document.getElementById("cityDisplay").innerText = "üìç " + cityName;
        }

    } catch(e) {
        console.error(e);
        alert("Kunde inte h√§mta b√∂netider");
    }
}

	async function askCity() {
    const city = prompt("Ange stad (t.ex. Stockholm):");
    if (!city) return;

    const country = prompt("Ange land (t.ex. Sweden):") || "";

    const geoRes = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city + " " + country)}`
    );
    const geoData = await geoRes.json();

    if (geoData.length === 0) {
        alert("Hittade inte staden.");
        return;
    }

    const lat = geoData[0].lat;
    const lon = geoData[0].lon;

    localStorage.setItem("lat", lat);
    localStorage.setItem("lon", lon);
    localStorage.setItem("cityName", city);

    loadPrayerTimes();
}

function changeCity() {
    localStorage.removeItem("lat");
    localStorage.removeItem("lon");
    localStorage.removeItem("cityName");
    askCity();
}



function renderPrayers() {
    const names = {fajr:'Fajr', sunrise:'Soluppg√•ng', dhuhr:'Dhuhr', asr:'Asr', maghrib:'Maghrib', isha:'Isha'};
    const icons = {fajr:'üåÖ', sunrise:'üåÑ', dhuhr:'‚òÄÔ∏è', asr:'üå§Ô∏è', maghrib:'üåá', isha:'üåå'};
    const grid = document.getElementById('prayerGrid');
    const now = new Date();
    const currentHour = now.getHours() + now.getMinutes()/60;
    
    grid.innerHTML = Object.entries(prayers).map(([key, time]) => {
        const [h,m] = time.split(':').map(Number);
        const prayerHour = h + m/60;
        const isNext = prayerHour > currentHour;
        return `
            <div class="prayer-card ${isNext?'active':''}">
                <div style="font-size: 1.8rem; margin-bottom: 5px;">${icons[key]}</div>
                <div style="color: #888; font-size: 0.75rem;">${names[key]}</div>
                <div style="font-family: Orbitron; font-size: 1.2rem; margin-top: 5px;">${time}</div>
            </div>
        `;
    }).join('');
}

function updateNextPrayer() {
    const now = new Date();
    const currentMin = now.getHours()*60 + now.getMinutes();
    const times = Object.entries(prayers)
        .filter(([k]) => k !== 'sunrise')
        .map(([name, time]) => {
            const [h,m] = time.split(':').map(Number);
            return {name, time, min: h*60+m};
        });
    const next = times.find(t => t.min > currentMin) || times[0];
    document.getElementById('nextPrayerTime').innerText = next.time;
    document.getElementById('nextPrayerName').innerText = next.name;
}

// ===== ALARM CHECK =====
function checkAlarms(now) {
    const timeStr = now.toTimeString().substring(0,5);
    const day = now.getDay();
    alarms.forEach(alarm => {
        if (alarm.time === timeStr && now.getSeconds() === 0 && alarm.days.includes(day)) {
            triggerAlarm(alarm);
        }
    });
}

function triggerAlarm(alarm) {
    document.getElementById('modalTime').innerText = alarm.time;
    document.getElementById('modalLabel').innerText = alarm.label;
    document.getElementById('alarmModal').classList.add('active');
    playAdhan(alarm.type);
    if (navigator.vibrate) navigator.vibrate([1000,500,1000,500,1000]);
    if (Notification.permission === 'granted') {
        new Notification('üïå B√∂neutrop', {body: `${alarm.label} - ${alarm.time}`});
    }
}

function showNotification(title,text) {
    const n = document.getElementById('notification');
    document.getElementById('notifTitle').innerText = title;
    document.getElementById('notifText').innerText = text;
    n.classList.add('show');
    setTimeout(()=>n.classList.remove('show'),3000);
}

async function requestWakeLock() {
    try { if('wakeLock' in navigator) await navigator.wakeLock.request('screen'); }
    catch(e){ console.log('Wake lock not supported'); }
}

// Init
document.getElementById('volumeSlider').addEventListener('input', (e)=>{
    alarmVolume = e.target.value/100;
    document.getElementById('volumeValue').innerText = e.target.value+'%';
    Object.values(adhanAudios).forEach(audio=>audio.volume = alarmVolume);
});

// Skapa stj√§rnor
for(let i=0;i<50;i++){
    const star = document.createElement('div');
    star.className='star';
    star.style.left=Math.random()*100+'%';
    star.style.top=Math.random()*100+'%';
    star.style.animationDelay=Math.random()*3+'s';
    document.getElementById('stars').appendChild(star);
}

updateDayButtons();
renderAlarms();
loadPrayerTimes();
setInterval(updateClock,1000);
if('Notification' in window) Notification.requestPermission();
</script>
</body>
</html>
